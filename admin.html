<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>✨ YURIDIA MAKEUP - Panel de Administración Premium</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts Poppins -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Scripts de Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, deleteDoc, updateDoc, query, orderBy, addDoc, setDoc, getDoc, where, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        // Configuración de Firebase (la misma que en la página principal)
        const firebaseConfig = {
            apiKey: "AIzaSyDdO86LeB2mUWeCb85FPw03XPR_ulGfIZA",
            authDomain: "citas-yuridia-makeup.firebaseapp.com",
            projectId: "citas-yuridia-makeup",
            storageBucket: "citas-yuridia-makeup.firebasestorage.app",
            messagingSenderId: "423454216995",
            appId: "1:423454216995:web:ec6f6b8f2b9bba4054b296",
            measurementId: "G-MHPETD64SS"
        };
        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        // Exponer funciones de Firebase para el script principal
        window.db = db;
        window.firebase = { collection, onSnapshot, doc, deleteDoc, updateDoc, query, orderBy, addDoc, setDoc, getDoc, where, getDocs };
    </script>
    
    <!-- EmailJS -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3.11.0/dist/email.min.js"></script>
    <script>
        (function() {
            // Inicializar EmailJS con la public key correcta
            emailjs.init("q14FqhdjUSICAGOTm");
            console.log('EmailJS inicializado correctamente');
        })();

        // Función para enviar correo de notificación de nueva cita
        async function sendAppointmentEmail(appointmentData) {
            try {
                const templateParams = {
                    to_name: "Yuridia",
                    from_name: appointmentData.nombre,
                    to_email: "yuridiamakeup@gmail.com",
                    client_phone: appointmentData.telefono,
                    message: `Nueva cita programada:
Nombre: ${appointmentData.nombre}
Servicio: ${appointmentData.servicio}
Fecha: ${appointmentData.fecha}
Hora: ${appointmentData.hora}
Teléfono: ${appointmentData.telefono}`
                };

                console.log('Enviando correo con parámetros:', templateParams);

                console.log('Intentando enviar correo con EmailJS...');
                
                await emailjs.send(
                    'service_zxp6znw',
                    'template_p59fp7s',
                    templateParams
                ).then(
                    function(response) {
                        console.log('¡ÉXITO!', response.status, response.text);
                        return response;
                    },
                    function(err) {
                        console.error('Error completo:', JSON.stringify(err));
                        throw new Error(`Error al enviar email: ${err.text}`);
                    }
                );
                
                console.log('Correo de notificación enviado correctamente');
            } catch (error) {
                console.error('Error al enviar correo de notificación:', error);
            }
        }
    </script>
    <style>
        /* Advanced Design System Variables */
        :root {
            --brand-rose: #e91e63;
            --brand-gold: #d4af37;
            --brand-charcoal: #2c2c2c;
            --brand-light: #fef7f7;
            --brand-gradient: linear-gradient(135deg, #e91e63 0%, #d4af37 50%, #e91e63 100%);
            
            /* Advanced Glass Morphism */
            --glass-bg: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.12);
            --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.06);
            
            /* Neumorphism Variables */
            --neu-bg: #f0f4f8;
            --neu-shadow-light: rgba(255, 255, 255, 0.8);
            --neu-shadow-dark: rgba(0, 0, 0, 0.1);
            
            /* Advanced Gradients */
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-success: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --gradient-warning: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
            --gradient-danger: linear-gradient(135deg, #ff758c 0%, #ff7eb3 100%);
            --gradient-glass: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
            
            /* Typography */
            --font-display: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            --font-body: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            
            /* Spacing System */
            --space-xs: 0.25rem;
            --space-sm: 0.5rem;
            --space-md: 1rem;
            --space-lg: 1.5rem;
            --space-xl: 2rem;
            --space-2xl: 3rem;
            
            /* Border Radius System */
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;
            
            /* Animation */
            --transition-smooth: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-bounce: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        /* Modern Dark Mode Adaptive Background */
        body {
            font-family: var(--font-display);
            background: 
                radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(120, 119, 198, 0.1) 0%, transparent 50%),
                linear-gradient(135deg, #f8fafc 0%, #e2e8f0 50%, #f1f5f9 100%);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        /* Animated Background Particles */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(120, 119, 198, 0.05) 0%, transparent 20%),
                radial-gradient(circle at 80% 80%, rgba(255, 119, 198, 0.03) 0%, transparent 20%),
                radial-gradient(circle at 40% 40%, rgba(120, 119, 198, 0.02) 0%, transparent 20%);
            animation: float 20s ease-in-out infinite;
            pointer-events: none;
            z-index: -1;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            33% { transform: translateY(-30px) rotate(5deg); }
            66% { transform: translateY(10px) rotate(-5deg); }
        }

        /* Advanced Glass Morphism Effects */
        .glass-effect {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            box-shadow: var(--glass-shadow);
            position: relative;
            overflow: hidden;
        }

        .glass-effect::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.5s;
        }

        .glass-effect:hover::before {
            left: 100%;
        }

        /* Neumorphism Effects */
        .neu-card {
            background: var(--neu-bg);
            border-radius: var(--radius-lg);
            box-shadow: 
                8px 8px 16px var(--neu-shadow-dark),
                -8px -8px 16px var(--neu-shadow-light);
            transition: var(--transition-smooth);
        }

        .neu-card:hover {
            box-shadow: 
                12px 12px 24px var(--neu-shadow-dark),
                -12px -12px 24px var(--neu-shadow-light);
            transform: translateY(-2px);
        }

        .neu-button {
            background: var(--neu-bg);
            border: none;
            border-radius: var(--radius-md);
            box-shadow: 
                4px 4px 8px var(--neu-shadow-dark),
                -4px -4px 8px var(--neu-shadow-light);
            transition: var(--transition-smooth);
            cursor: pointer;
        }

        .neu-button:active {
            box-shadow: 
                inset 4px 4px 8px var(--neu-shadow-dark),
                inset -4px -4px 8px var(--neu-shadow-light);
            transform: scale(0.98);
        }

        /* Advanced Gradient Buttons */
        .btn-gradient {
            background: var(--gradient-primary);
            border: none;
            border-radius: var(--radius-md);
            color: white;
            font-weight: 600;
            padding: var(--space-md) var(--space-lg);
            cursor: pointer;
            transition: var(--transition-smooth);
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-gradient::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.3s;
        }

        .btn-gradient:hover::before {
            left: 100%;
        }

        .btn-gradient:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
        }

        .btn-gradient:disabled {
            background: linear-gradient(135deg, #9ca3af 0%, #6b7280 100%);
            cursor: not-allowed;
            opacity: 0.6;
            transform: none;
            box-shadow: 0 2px 8px rgba(156, 163, 175, 0.3);
        }

        .btn-gradient:disabled:hover {
            transform: none;
            box-shadow: 0 2px 8px rgba(156, 163, 175, 0.3);
        }

        /* Modern Cards with 3D Effects */
        .modern-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--radius-xl);
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.1),
                0 4px 16px rgba(0, 0, 0, 0.05),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
            transition: var(--transition-smooth);
            position: relative;
            overflow: hidden;
        }

        .modern-card:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 
                0 20px 40px rgba(0, 0, 0, 0.15),
                0 8px 24px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.4);
        }

        /* Floating Action Buttons */
        .fab {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--gradient-primary);
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4);
            transition: var(--transition-bounce);
            z-index: 1000;
        }

        .fab:hover {
            transform: scale(1.1);
            box-shadow: 0 12px 32px rgba(102, 126, 234, 0.6);
        }

        /* Advanced Typography */
        .text-gradient {
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700;
        }

        .text-brand-pink {
            color: var(--brand-rose);
        }

        /* Efecto Shimmer Premium para YURIDIA MAKEUP */
        .shimmer-effect {
            background: linear-gradient(135deg, 
                var(--brand-rose) 0%, 
                var(--brand-gold) 15%, 
                #ffffff 30%,
                var(--brand-gold) 45%,
                var(--brand-rose) 60%, 
                var(--brand-gold) 75%, 
                #ffffff 90%,
                var(--brand-rose) 100%);
            background-size: 400% 400%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: shimmer-luxury 4s ease-in-out infinite;
            font-family: 'Poppins', sans-serif;
            letter-spacing: 3px;
            text-shadow: 0 0 40px rgba(233, 30, 99, 0.4);
            position: relative;
        }

        .shimmer-effect::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.6), transparent);
            animation: shimmer-sweep 2s ease-in-out infinite;
        }

        @keyframes shimmer-luxury {
            0%, 100% { 
                background-position: 0% 50%; 
                filter: brightness(1) saturate(1.2);
            }
            25% { 
                background-position: 50% 50%; 
                filter: brightness(1.3) saturate(1.4);
            }
            50% { 
                background-position: 100% 50%; 
                filter: brightness(1.1) saturate(1.1);
            }
            75% { 
                background-position: 150% 50%; 
                filter: brightness(1.4) saturate(1.5);
            }
        }

        @keyframes shimmer-sweep {
            0% { left: -100%; }
            50% { left: 100%; }
            100% { left: 100%; }
        }

        /* Mejoras para el texto gradient */
        .text-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #667eea 100%);
            background-size: 200% 200%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 900;
            animation: gradient-shift 3s ease-in-out infinite;
        }

        @keyframes gradient-shift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        /* Advanced Loading States */
        .loading-skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: var(--radius-sm);
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Micro-interactions */
        .micro-bounce {
            transition: var(--transition-bounce);
        }

        .micro-bounce:hover {
            transform: scale(1.05);
        }

        .micro-bounce:active {
            transform: scale(0.95);
        }

        /* Modern Touch Targets */
        .touch-target {
            min-height: 48px;
            min-width: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-md);
            transition: var(--transition-smooth);
            position: relative;
            overflow: hidden;
        }

        .touch-target::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.3s, height 0.3s;
        }

        .touch-target:active::before {
            width: 200px;
            height: 200px;
        }

        /* Advanced Time Slot Design */
        .time-slot {
            transition: var(--transition-smooth);
            cursor: pointer;
            min-width: 80px;
            text-align: center;
            padding: var(--space-md);
            font-size: 0.875rem;
            border-radius: var(--radius-lg);
            font-weight: 600;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
            border: 2px solid transparent;
        }

        .time-slot::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--gradient-glass);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .time-slot:hover::before {
            opacity: 1;
        }

        .time-slot:active {
            transform: scale(0.96);
        }

        /* Enhanced Time Slot States */
        .time-slot.available {
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
            border-color: #86efac;
            color: #166534;
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.2);
        }

        .time-slot.available:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(34, 197, 94, 0.3);
        }

        .time-slot.unavailable {
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            border-color: #d1d5db;
            color: #6b7280;
            opacity: 0.6;
            cursor: not-allowed;
        }

        .time-slot.selected {
            background: var(--gradient-success);
            border-color: #22c55e;
            color: white;
            transform: scale(1.05);
            box-shadow: 0 8px 24px rgba(34, 197, 94, 0.4);
            z-index: 10;
        }

        .time-slot.occupied {
            background: var(--gradient-primary);
            border-color: #60a5fa;
            color: white;
            box-shadow: 0 4px 12px rgba(96, 165, 250, 0.3);
        }

        /* Estados pendientes para selección múltiple */
        .time-slot.pending-block {
            background: linear-gradient(135deg, #fed7d7 0%, #feb2b2 100%);
            border-color: #f56565;
            color: #c53030;
            box-shadow: 0 4px 12px rgba(245, 101, 101, 0.3);
            animation: pending-pulse 2s ease-in-out infinite;
            position: relative;
        }

        .time-slot.pending-block::after {
            content: '🚫';
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 0.7rem;
        }

        .time-slot.pending-unblock {
            background: linear-gradient(135deg, #c6f6d5 0%, #9ae6b4 100%);
            border-color: #48bb78;
            color: #2f855a;
            box-shadow: 0 4px 12px rgba(72, 187, 120, 0.3);
            animation: pending-pulse 2s ease-in-out infinite;
            position: relative;
        }

        .time-slot.pending-unblock::after {
            content: '✅';
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 0.7rem;
        }

        @keyframes pending-pulse {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.05);
                opacity: 0.8;
            }
        }

        /* Advanced Calendar Day Design */
        .calendar-day {
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--radius-xl);
            padding: var(--space-lg);
            min-height: 320px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            transition: var(--transition-smooth);
            display: flex;
            flex-direction: column;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }

        .calendar-day::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
            transform: scaleX(0);
            transition: transform 0.3s;
        }

        .calendar-day:hover::before {
            transform: scaleX(1);
        }

        .calendar-day.today {
            border-color: #3b82f6;
            background: linear-gradient(135deg, rgba(239, 246, 255, 0.9) 0%, rgba(219, 234, 254, 0.9) 100%);
            box-shadow: 0 12px 40px rgba(59, 130, 246, 0.2);
        }

        .calendar-day.has-appointments {
            border-color: #10b981;
            background: linear-gradient(135deg, rgba(236, 253, 245, 0.9) 0%, rgba(209, 250, 229, 0.9) 100%);
            box-shadow: 0 12px 40px rgba(16, 185, 129, 0.2);
            animation: pulse-glow 3s ease-in-out infinite;
        }

        @keyframes pulse-glow {
            0%, 100% {
                box-shadow: 0 12px 40px rgba(16, 185, 129, 0.2);
            }
            50% {
                box-shadow: 0 16px 48px rgba(16, 185, 129, 0.4);
            }
        }

        /* Modern Appointment Items */
        .appointment-item {
            background: var(--gradient-primary);
            border: none;
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            margin-bottom: var(--space-md);
            font-size: 0.875rem;
            font-weight: 600;
            color: white;
            transition: var(--transition-smooth);
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.3);
            position: relative;
            overflow: hidden;
        }

        .appointment-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.4s;
        }

        .appointment-item:hover::before {
            left: 100%;
        }

        .appointment-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 32px rgba(102, 126, 234, 0.5);
        }

        /* Enhanced Tables */
        .modern-table {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .modern-table th {
            background: var(--gradient-primary);
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: var(--space-lg);
        }

        .modern-table td {
            padding: var(--space-lg);
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            transition: var(--transition-smooth);
        }

        .modern-table tr:hover td {
            background: rgba(102, 126, 234, 0.05);
        }

        /* Status Indicators */
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: var(--space-xs) var(--space-md);
            border-radius: var(--radius-lg);
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .status-confirmed {
            background: var(--gradient-success);
            color: white;
        }

        .status-pending {
            background: var(--gradient-warning);
            color: white;
        }

        .status-cancelled {
            background: var(--gradient-danger);
            color: white;
        }

        /* Responsive Design Enhancements */
        @media (max-width: 768px) {
            /* Reducir contenedor principal */
            .container {
                padding: 0.5rem !important;
            }

            /* Títulos más pequeños */
            h1 {
                font-size: 1.5rem !important;
                line-height: 1.3 !important;
                margin-bottom: 0.75rem !important;
            }

            h2 {
                font-size: 1.25rem !important;
                line-height: 1.4 !important;
                margin-bottom: 0.5rem !important;
            }

            h3 {
                font-size: 1.1rem !important;
                line-height: 1.4 !important;
                margin-bottom: 0.5rem !important;
            }

            /* Ajustar shimmer effect para móvil */
            .shimmer-effect {
                font-size: 1.5rem !important;
                letter-spacing: 1px !important;
                line-height: 1.2 !important;
            }

            /* Cards más compactas */
            .modern-card {
                border-radius: var(--radius-md);
                margin: 0.25rem !important;
                padding: 0.75rem !important;
            }

            /* Botones más pequeños */
            .btn-gradient, button {
                padding: 0.5rem 0.75rem !important;
                font-size: 0.75rem !important;
                border-radius: 8px !important;
            }

            /* Espaciado reducido */
            .space-y-4 > * + * {
                margin-top: 0.75rem !important;
            }

            .space-y-6 > * + * {
                margin-top: 1rem !important;
            }

            /* Texto más pequeño */
            .text-lg {
                font-size: 1rem !important;
            }

            .text-xl {
                font-size: 1.125rem !important;
            }

            .text-2xl {
                font-size: 1.25rem !important;
            }

            .text-3xl {
                font-size: 1.5rem !important;
            }

            /* Tablas responsivas */
            .modern-table th,
            .modern-table td {
                padding: 0.5rem !important;
                font-size: 0.75rem !important;
            }

            /* Calendario más compacto */
            .calendar-day {
                min-height: 200px !important;
                padding: 0.5rem !important;
                margin-bottom: 0.5rem !important;
            }

            /* Horarios más pequeños */
            .time-slot {
                min-width: 60px !important;
                padding: 0.4rem 0.5rem !important;
                font-size: 0.7rem !important;
                margin: 0.125rem !important;
            }

            /* Items de citas más compactos */
            .appointment-item {
                padding: 0.5rem !important;
                margin-bottom: 0.5rem !important;
                font-size: 0.7rem !important;
                line-height: 1.3 !important;
            }

            /* Status badges más pequeños */
            .status-badge {
                padding: 0.125rem 0.5rem !important;
                font-size: 0.625rem !important;
            }

            /* FAB ajustado */
            .fab {
                bottom: 1rem;
                right: 1rem;
                width: 45px;
                height: 45px;
                font-size: 1.1rem;
            }

            /* Inputs y selects más compactos */
            input, select, textarea {
                padding: 0.5rem !important;
                font-size: 0.875rem !important;
            }

            /* Grids responsivos */
            .grid {
                gap: 0.5rem !important;
            }

            /* Navegación admin más compacta */
            .admin-nav {
                flex-wrap: wrap;
                gap: 0.25rem !important;
            }

            .admin-nav button {
                padding: 0.5rem 0.75rem !important;
                font-size: 0.75rem !important;
                margin: 0.125rem !important;
            }

            /* Formularios más compactos */
            .form-group {
                margin-bottom: 0.75rem !important;
            }

            /* Labels más pequeños */
            label {
                font-size: 0.75rem !important;
                margin-bottom: 0.25rem !important;
            }

            /* Reducir padding general */
            .p-4 {
                padding: 0.75rem !important;
            }

            .p-6 {
                padding: 1rem !important;
            }

            .p-8 {
                padding: 1.25rem !important;
            }

            /* Márgenes más pequeños */
            .m-4 {
                margin: 0.75rem !important;
            }

            .mb-4 {
                margin-bottom: 0.75rem !important;
            }

            .mb-6 {
                margin-bottom: 1rem !important;
            }

            /* Hacer que el contenido use todo el ancho disponible */
            .max-w-7xl {
                max-width: 100% !important;
            }

            .max-w-6xl {
                max-width: 100% !important;
            }

            .max-w-4xl {
                max-width: 100% !important;
            }

            /* Ajustar contenedores flex */
            .flex-col {
                gap: 0.5rem !important;
            }

            /* Scroll horizontal para tablas */
            .table-container {
                overflow-x: auto !important;
                -webkit-overflow-scrolling: touch !important;
            }
        }

        /* Estilos para pantallas muy pequeñas (teléfonos) */
        @media (max-width: 480px) {
            /* Contenedor aún más compacto */
            .container {
                padding: 0.25rem !important;
            }

            /* Títulos muy pequeños */
            h1 {
                font-size: 1.25rem !important;
                line-height: 1.2 !important;
            }

            h2 {
                font-size: 1.1rem !important;
                line-height: 1.3 !important;
            }

            h3 {
                font-size: 1rem !important;
                line-height: 1.3 !important;
            }

            /* Shimmer effect muy compacto */
            .shimmer-effect {
                font-size: 1.25rem !important;
                letter-spacing: 0.5px !important;
                line-height: 1.1 !important;
            }

            /* Cards súper compactas */
            .modern-card {
                padding: 0.5rem !important;
                margin: 0.125rem !important;
            }

            /* Botones mini */
            .btn-gradient, button {
                padding: 0.375rem 0.5rem !important;
                font-size: 0.7rem !important;
            }

            /* Calendario mínimo */
            .calendar-day {
                min-height: 150px !important;
                padding: 0.375rem !important;
            }

            /* Horarios mini */
            .time-slot {
                min-width: 50px !important;
                padding: 0.25rem 0.375rem !important;
                font-size: 0.625rem !important;
            }

            /* Items de citas mini */
            .appointment-item {
                padding: 0.375rem !important;
                font-size: 0.625rem !important;
                line-height: 1.2 !important;
            }

            /* Inputs mini */
            input, select, textarea {
                padding: 0.375rem !important;
                font-size: 0.75rem !important;
            }

            /* Labels mini */
            label {
                font-size: 0.7rem !important;
            }

            /* Navegación super compacta */
            .admin-nav button {
                padding: 0.375rem 0.5rem !important;
                font-size: 0.7rem !important;
            }

            /* FAB más pequeño */
            .fab {
                width: 40px;
                height: 40px;
                font-size: 1rem;
                bottom: 0.5rem;
                right: 0.5rem;
            }

            /* Texto general más pequeño */
            body {
                font-size: 0.75rem !important;
                line-height: 1.3 !important;
            }

            /* Tablas mini */
            .modern-table th,
            .modern-table td {
                padding: 0.25rem !important;
                font-size: 0.625rem !important;
            }
        }

        /* Estilos para el botón de confirmación parpadeante */
        @keyframes blink {
            50% {
                opacity: 0.6;
            }
        }
        .confirm-btn-pending {
            animation: blink 1.5s linear infinite;
        }

        /* Estilos para el calendario semanal responsivo */
        .calendar-day {
            border: 2px solid #e5e7eb;
            border-radius: 1rem;
            padding: 1rem;
            min-height: 300px;
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }

        .calendar-day.today {
            border-color: #3b82f6;
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            box-shadow: 0 12px 25px rgba(59, 130, 246, 0.2);
        }

        .calendar-day.has-appointments {
            border-color: #10b981;
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            box-shadow: 0 12px 25px rgba(16, 185, 129, 0.2);
            animation: has-appointments-glow 4s ease-in-out infinite;
        }

        .calendar-day.full-day {
            border-color: #ef4444;
            background: linear-gradient(135deg, #fef2f2 0%, #fecaca 100%);
            box-shadow: 0 12px 25px rgba(239, 68, 68, 0.2);
        }

        @keyframes has-appointments-glow {
            0%, 100% {
                border-color: #10b981;
                box-shadow: 0 12px 25px rgba(16, 185, 129, 0.2);
            }
            50% {
                border-color: #059669;
                box-shadow: 0 12px 25px rgba(16, 185, 129, 0.4);
            }
        }

        .appointment-item {
            background: var(--brand-gradient);
            border: 2px solid #ffffff;
            border-radius: 0.75rem;
            padding: 0.75rem;
            margin-bottom: 0.75rem;
            font-size: 0.875rem;
            font-weight: 600;
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(233, 30, 99, 0.3);
        }

        .appointment-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(233, 30, 99, 0.4);
        }

        /* Estilos para la vista del día */
        .daily-appointments-container {
            max-width: 100%;
            overflow: hidden;
        }

        .calendar-day {
            background: white;
            border-radius: 12px;
            border: 2px solid #e5e7eb;
            transition: all 0.3s ease;
            position: relative;
        }

        .calendar-day.today {
            border-color: #3b82f6;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
        }

        .day-header {
            text-align: center;
            padding: 1rem;
            border-bottom: 1px solid #e5e7eb;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-radius: 10px 10px 0 0;
        }

        .day-header.has-appointments-header {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
        }

        .day-name {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            color: #374151;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .day-number {
            display: block;
            font-size: 1.5rem;
            font-weight: 700;
            color: #1f2937;
            margin-top: 0.25rem;
        }

        .calendar-day.today .day-name {
            color: #2563eb;
        }

        .calendar-day.today .day-number {
            color: #1d4ed8;
        }

        .appointments-list {
            padding: 1rem;
            max-height: 500px;
            overflow-y: auto;
        }

        .appointment-item {
            transition: all 0.2s ease;
            border-radius: 8px;
        }

        .appointment-item:hover {
            transform: translateY(-1px);
        }

        .appointments-summary {
            border-top: 1px solid #e5e7eb;
            background: #f8fafc;
            border-radius: 0 0 10px 10px;
        }

        /* Navegación del día */
        .admin-nav button {
            transition: all 0.2s ease;
        }

        .admin-nav button:hover {
            transform: translateY(-1px);
        }

        .admin-nav button:active {
            transform: translateY(0);
        }

        /* Responsive para vista del día */
        @media (max-width: 768px) {
            .daily-appointments-container {
                margin: 0 -0.5rem;
                padding: 0.25rem;
            }
            
            .calendar-day {
                border-radius: 8px;
                border: 1px solid #e5e7eb;
                margin-bottom: 0.5rem;
            }
            
            .day-header {
                padding: 0.5rem;
            }
            
            .day-name {
                font-size: 0.75rem !important;
            }
            
            .day-number {
                font-size: 1rem !important;
            }
            
            .appointment-item {
                margin-bottom: 0.5rem;
                padding: 0.5rem;
                font-size: 0.75rem;
            }
            
            .appointments-list {
                padding: 0.5rem;
            }
            
            .appointments-summary {
                padding: 0.5rem;
                font-size: 0.75rem;
            }
        }

        /* Responsive extra pequeño para vista del día */
        @media (max-width: 480px) {
            .daily-appointments-container {
                margin: 0 -0.25rem;
                padding: 0.125rem;
            }
            
            .calendar-day {
                border-radius: 6px;
                margin-bottom: 0.375rem;
            }
            
            .day-header {
                padding: 0.375rem;
            }
            
            .day-name {
                font-size: 0.7rem !important;
            }
            
            .day-number {
                font-size: 0.875rem !important;
            }
            
            .appointment-item {
                margin-bottom: 0.375rem;
                padding: 0.375rem;
                font-size: 0.7rem;
                line-height: 1.2;
            }
            
            .appointments-list {
                padding: 0.375rem;
            }
            
            .appointments-summary {
                padding: 0.375rem;
                font-size: 0.7rem;
            }
        }

        /* Estados de citas */
        .border-l-green-500 {
            border-left-color: #10b981 !important;
        }

        .border-l-yellow-500 {
            border-left-color: #f59e0b !important;
        }

        .border-l-red-500 {
            border-left-color: #ef4444 !important;
        }

        .bg-green-500 {
            background-color: #10b981 !important;
        }

        .bg-yellow-500 {
            background-color: #f59e0b !important;
        }

        .bg-red-500 {
            background-color: #ef4444 !important;
        }
        
        /* Animación de shake para errores */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        
        .shake {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }

        /* Estilos adicionales para mejorar la experiencia móvil */
        @media (max-width: 768px) {
            /* Prevenir zoom accidental en inputs */
            input[type="text"], 
            input[type="email"], 
            input[type="tel"], 
            input[type="number"], 
            select, 
            textarea {
                font-size: 16px !important; /* Previene zoom en iOS */
            }

            /* Mejorar la visualización de elementos tactiles */
            button, 
            .time-slot, 
            .appointment-item, 
            .touch-target {
                min-height: 44px !important; /* Estándar de Apple para táctil */
                touch-action: manipulation; /* Mejora respuesta táctil */
            }

            /* Optimizar scrolling en móviles */
            body {
                -webkit-overflow-scrolling: touch;
                overscroll-behavior: contain;
            }

            /* Reducir animaciones en móviles para mejor rendimiento */
            *, *::before, *::after {
                animation-duration: 0.2s !important;
                transition-duration: 0.2s !important;
            }

            /* Mejorar legibilidad del texto en pantallas pequeñas */
            p, li, span, div {
                line-height: 1.4 !important;
            }

            /* Hacer que los modales sean más amigables en móvil */
            .modal, .dialog {
                margin: 0.5rem !important;
                max-height: 90vh !important;
                overflow-y: auto !important;
            }

            /* Optimizar listas y grids para móvil */
            .grid-cols-7 {
                grid-template-columns: repeat(7, 1fr) !important;
                gap: 0.25rem !important;
            }

            .grid-cols-1 {
                gap: 0.5rem !important;
            }

            /* Hacer que las tablas sean más manejables */
            table {
                font-size: 0.75rem !important;
                width: 100% !important;
            }

            /* Mejorar la navegación por pestañas en móvil */
            .tab-container {
                overflow-x: auto !important;
                -webkit-overflow-scrolling: touch !important;
            }

            .tab-buttons {
                display: flex !important;
                flex-wrap: nowrap !important;
                min-width: max-content !important;
            }

            /* Optimizar formularios para móvil */
            .form-container {
                padding: 0.5rem !important;
            }

            .form-row {
                flex-direction: column !important;
                gap: 0.5rem !important;
            }

            /* Hacer que los contenedores de horarios sean más usables */
            .time-slots-container {
                display: grid !important;
                grid-template-columns: repeat(auto-fit, minmax(60px, 1fr)) !important;
                gap: 0.25rem !important;
                padding: 0.5rem !important;
            }

            /* Mejorar la visibilidad de estados */
            .time-slot.selected {
                transform: scale(0.95) !important;
                font-weight: bold !important;
            }

            .time-slot.unavailable {
                opacity: 0.5 !important;
            }

            /* Optimizar el header para móvil */
            .header-title {
                text-align: center !important;
                word-break: break-word !important;
            }

            /* Hacer scroll más suave en contenedores */
            .scrollable {
                scroll-behavior: smooth !important;
                -webkit-overflow-scrolling: touch !important;
            }
        }

        /* Ajustes específicos para pantallas muy pequeñas */
        @media (max-width: 480px) {
            /* Reducir aún más el espaciado */
            .space-y-2 > * + * {
                margin-top: 0.25rem !important;
            }

            .space-y-3 > * + * {
                margin-top: 0.375rem !important;
            }

            /* Hacer que el grid de horarios sea más compacto */
            .time-slots-container {
                grid-template-columns: repeat(auto-fit, minmax(50px, 1fr)) !important;
                gap: 0.125rem !important;
            }

            /* Optimizar la navegación de pestañas */
            .tab-buttons button {
                font-size: 0.7rem !important;
                padding: 0.375rem 0.5rem !important;
                white-space: nowrap !important;
            }

            /* Mejorar la legibilidad de las fechas */
            .date-display {
                font-size: 0.8rem !important;
                font-weight: 600 !important;
            }

            /* Optimizar botones de acción */
            .action-buttons {
                display: flex !important;
                flex-direction: column !important;
                gap: 0.25rem !important;
            }

            .action-buttons button {
                width: 100% !important;
                text-align: center !important;
            }
        }
    </style>
</head>
<body class="text-gray-800">
    <!-- Pantalla de Contraseña (ahora oculta por defecto) -->
    <div id="password-screen" class="fixed inset-0 bg-gray-800 flex items-center justify-center z-20 p-4 hidden">
        <div class="glass-effect p-6 md:p-8 rounded-2xl shadow-2xl text-center max-w-sm w-full mx-auto">
            <h2 class="text-xl md:text-2xl font-bold mb-4 text-gray-800">Acceso de Administrador</h2>
            <p class="text-gray-600 mb-6 text-sm md:text-base">Por favor, introduce la contraseña para continuar.</p>
            <form id="login-form" onsubmit="return false;">
                <input type="password" id="password-input" class="w-full p-3 md:p-4 border border-gray-300 rounded-xl text-center touch-target" placeholder="Contraseña" style="font-size: 16px;" autocomplete="current-password">
                <button type="submit" id="password-submit" class="w-full mt-4 bg-gradient-to-r from-blue-600 to-blue-700 text-white p-3 md:p-4 rounded-xl font-bold hover:from-blue-700 hover:to-blue-800 transition touch-target">Entrar</button>
                <p id="password-error" class="text-red-500 text-sm mt-2 hidden">Contraseña incorrecta.</p>
            </form>
        </div>
    </div>

    <!-- Contenido del Panel (ahora visible por defecto) -->
    <div id="admin-panel" class="container mx-auto p-2 md:p-4 lg:p-8">
        <!-- Modern Header with Glass Effect -->
        <header class="modern-card mb-8 p-6 md:p-8">
            <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-6">
                <div class="flex-1">
                    <div class="flex items-center gap-4 mb-4">
                        <div class="flex flex-col cursor-pointer hover:scale-105 transition-transform duration-300" onclick="scrollToTop()">
                            <h1 class="text-4xl md:text-6xl lg:text-7xl font-black text-gradient mb-1 tracking-tight">
                                YURIDIA
                            </h1>
                            <div class="relative">
                                <p class="text-2xl md:text-4xl lg:text-5xl font-bold shimmer-effect tracking-widest">
                                    MAKEUP
                                </p>
                                <div class="absolute -bottom-2 left-0 w-full h-1 bg-gradient-to-r from-transparent via-brand-gold to-transparent opacity-60"></div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-gradient-to-r from-brand-rose/10 via-brand-gold/10 to-brand-rose/10 rounded-2xl p-4 mb-4 border border-brand-gold/20">
                        <p class="text-gray-700 text-lg md:text-xl font-semibold text-center">
                            ✨ Panel de Control Luxury • Gestión Premium de Citas ✨
                        </p>
                    </div>
                    <div class="flex items-center mt-4 space-x-4">
                        <div class="flex items-center space-x-2">
                            <div class="w-3 h-3 bg-green-400 rounded-full animate-pulse"></div>
                            <span class="text-sm text-gray-500">Sistema activo</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <div class="w-3 h-3 bg-blue-400 rounded-full"></div>
                            <span class="text-sm text-gray-500">Conectado a Firebase</span>
                        </div>
                    </div>
                </div>
                <div class="flex flex-col sm:flex-row gap-3">
                    <button class="btn-gradient micro-bounce">
                        <svg class="w-5 h-5 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                        </svg>
                        Nueva Cita
                    </button>
                    <button class="neu-button text-gray-700 px-4 py-3">
                        <svg class="w-5 h-5 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3a4 4 0 118 0v4m-4 8a2 2 0 11-4 0m4 0a2 2 0 104 0m-4 0V9a2 2 0 014 0v4"/>
                        </svg>
                        Configuración
                    </button>
                </div>
            </div>
        </header>

        <main>
            <!-- Dashboard Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="modern-card p-6 text-center">
                    <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-gradient-to-r from-blue-500 to-purple-600 flex items-center justify-center">
                        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3a4 4 0 118 0v4m-4 8a2 2 0 11-4 0m4 0a2 2 0 104 0m-4 0V9a2 2 0 014 0v4"/>
                        </svg>
                    </div>
                    <h3 id="citas-hoy-count" class="text-2xl font-bold text-gray-800 mb-2">0</h3>
                    <p class="text-gray-600">Citas Hoy</p>
                </div>
                
                <div class="modern-card p-6 text-center">
                    <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-gradient-to-r from-green-500 to-teal-600 flex items-center justify-center">
                        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4"/>
                        </svg>
                    </div>
                    <h3 id="confirmadas-count" class="text-2xl font-bold text-gray-800 mb-2">0</h3>
                    <p class="text-gray-600">Confirmadas</p>
                </div>
                
                <div class="modern-card p-6 text-center">
                    <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-gradient-to-r from-yellow-500 to-orange-600 flex items-center justify-center">
                        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3"/>
                        </svg>
                    </div>
                    <h3 id="pendientes-count" class="text-2xl font-bold text-gray-800 mb-2">0</h3>
                    <p class="text-gray-600">Pendientes</p>
                </div>
                
                <div class="modern-card p-6 text-center">
                    <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-gradient-to-r from-pink-500 to-rose-600 flex items-center justify-center">
                        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
                        </svg>
                    </div>
                    <h3 id="satisfaccion-count" class="text-2xl font-bold text-gray-800 mb-2">100%</h3>
                    <p class="text-gray-600">Satisfacción</p>
                </div>
            </div>

            <!-- Citas de Hoy con diseño moderno -->
            <div class="modern-card p-8 mb-8">
                <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-6 gap-4">
                    <div>
                        <h2 class="text-2xl md:text-3xl font-bold text-gradient mb-2">Agenda de Hoy</h2>
                        <p class="text-gray-600" id="today-date"></p>
                    </div>
                    <div class="flex items-center space-x-3">
                        <div class="status-badge status-confirmed">
                            <span class="w-2 h-2 bg-white rounded-full mr-2"></span>
                            En vivo
                        </div>
                    </div>
                </div>
                
                <div class="modern-table overflow-x-auto">
                    <table class="min-w-full">
                        <thead>
                            <tr>
                                <th class="text-left">Hora</th>
                                <th class="text-left">Cliente</th>
                                <th class="text-left">Servicio</th>
                                <th class="text-left hide-mobile">Teléfono</th>
                                <th class="text-left">Estado</th>
                            </tr>
                        </thead>
                        <tbody id="today-appointments-body">
                            <tr><td colspan="5" class="text-center text-gray-500 py-8">
                                <div class="loading-skeleton h-4 w-32 mx-auto mb-2"></div>
                                <div class="loading-skeleton h-4 w-48 mx-auto"></div>
                            </td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Citas Próximas con diseño avanzado -->
            <div class="modern-card p-8 mb-8">
                <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-6 gap-4">
                    <div>
                        <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-2">Gestión de Citas</h2>
                        <p class="text-gray-600">Administra todas las citas programadas</p>
                    </div>
                    <button id="open-manual-appointment-modal-btn" class="btn-gradient micro-bounce">
                        <svg class="w-5 h-5 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                        </svg>
                        Agendar Nueva Cita
                    </button>
                </div>
                
                <div class="modern-table overflow-x-auto">
                    <table class="min-w-full">
                        <thead>
                            <tr>
                                <th class="text-left">
                                    <button id="sort-date-btn" class="flex items-center hover:text-white transition touch-target">
                                        Fecha
                                        <span id="sort-icon" class="ml-2">
                                            <svg id="sort-asc" class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
                                            </svg>
                                            <svg id="sort-desc" class="w-4 h-4 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                            </svg>
                                        </span>
                                    </button>
                                </th>
                                <th class="text-left">Hora</th>
                                <th class="text-left">Cliente</th>
                                <th class="text-left hide-mobile">Teléfono</th>
                                <th class="text-left">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="appointments-table-body">
                            <tr><td colspan="5" class="text-center text-gray-500 py-8">
                                <div class="loading-skeleton h-4 w-32 mx-auto mb-2"></div>
                                <div class="loading-skeleton h-4 w-48 mx-auto"></div>
                            </td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- Gestor de Horarios Bloqueados con diseño futurista -->
            <div class="modern-card p-8 mb-8">
                <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-6 gap-4">
                    <div>
                        <h2 class="text-2xl md:text-3xl font-bold text-gradient mb-2">⚡ Centro de Control de Horarios</h2>
                        <p class="text-gray-600">Gestiona la disponibilidad con tecnología avanzada • Selección múltiple activada</p>
                    </div>
                    <div class="flex flex-wrap gap-3">
                        <button id="clear-all-changes" class="neu-button text-gray-700 px-4 py-3 text-sm">
                            <svg class="w-4 h-4 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                            </svg>
                            Limpiar Cambios
                        </button>
                        <button id="save-blocked-hours" class="btn-gradient micro-bounce" disabled>
                            <svg class="w-5 h-5 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                            </svg>
                            Guardar Configuración
                        </button>
                    </div>
                </div>
                
                <div class="mb-6">
                    <label for="block-date" class="block text-sm font-semibold text-gray-700 mb-3">
                        📅 Seleccionar Fecha para Configurar
                    </label>
                    <input type="date" id="block-date" 
                           class="neu-button p-4 text-gray-700 rounded-lg w-full md:w-auto border-0 focus:ring-4 focus:ring-blue-200 transition"
                           style="font-size: 16px;">
                </div>
                
                <div class="bg-gradient-to-br from-gray-50 to-white rounded-2xl p-6 border border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                        <span class="w-3 h-3 bg-blue-500 rounded-full mr-3 animate-pulse"></span>
                        Matriz de Disponibilidad Horaria
                    </h3>
                    <div id="time-slots-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 xl:grid-cols-8 gap-3 max-h-[500px] overflow-y-auto">
                        <!-- Los slots de tiempo se generarán aquí -->
                    </div>
                    <div class="mt-6 p-4 bg-gradient-to-r from-gray-50 to-white rounded-lg border border-gray-200">
                        <h4 class="text-sm font-semibold text-gray-700 mb-3">🎯 Leyenda del Sistema</h4>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                            <div class="flex items-center">
                                <div class="w-4 h-4 rounded bg-gradient-to-r from-green-400 to-green-500 mr-2"></div>
                                <span class="text-gray-600">Disponible</span>
                            </div>
                            <div class="flex items-center">
                                <div class="w-4 h-4 rounded bg-gradient-to-r from-gray-300 to-gray-400 mr-2"></div>
                                <span class="text-gray-600">Bloqueado</span>
                            </div>
                            <div class="flex items-center">
                                <div class="w-4 h-4 rounded bg-gradient-to-r from-red-300 to-red-400 mr-2"></div>
                                <span class="text-gray-600">Se bloqueará 🚫</span>
                            </div>
                            <div class="flex items-center">
                                <div class="w-4 h-4 rounded bg-gradient-to-r from-green-300 to-green-400 mr-2"></div>
                                <span class="text-gray-600">Se habilitará ✅</span>
                            </div>
                        </div>
                        <div class="mt-3 text-xs text-gray-500 bg-blue-50 p-3 rounded border border-blue-200">
                            <strong>💡 Instrucciones:</strong> Haz clic en cualquier horario para cambiar su estado. 
                            Los cambios se marcan visualmente y se guardan todos juntos al presionar "Guardar Cambios".
                        </div>
                    </div>
                </div>
            </div>

            <!-- Registro de Cancelaciones con diseño moderno -->
            <div class="modern-card p-8 mb-8">
                <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-6 gap-4">
                    <div class="flex items-center">
                        <div class="w-12 h-12 rounded-full bg-gradient-to-r from-red-500 to-pink-600 flex items-center justify-center mr-4">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4"/>
                            </svg>
                        </div>
                        <div>
                            <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-1">Historial de Cancelaciones</h2>
                            <p class="text-gray-600">Registro completo de citas canceladas</p>
                        </div>
                    </div>
                    <button id="clear-history-btn" class="btn-gradient micro-bounce bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700">
                        <svg class="w-5 h-5 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                        </svg>
                        Limpiar Historial
                    </button>
                </div>
                
                <div class="modern-table overflow-x-auto">
                    <table class="min-w-full">
                        <thead>
                            <tr>
                                <th class="text-left">Fecha Original</th>
                                <th class="text-left">Hora</th>
                                <th class="text-left">Cliente & Servicio</th>
                                <th class="text-left hide-mobile">Contacto</th>
                                <th class="text-left">Motivo de Cancelación</th>
                            </tr>
                        </thead>
                        <tbody id="cancel-log-table-body">
                            <tr><td colspan="5" class="text-center text-gray-500 py-8">
                                <div class="loading-skeleton h-4 w-32 mx-auto mb-2"></div>
                                <div class="loading-skeleton h-4 w-48 mx-auto"></div>
                            </td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal de Confirmación de Cancelación con diseño futurista -->
    <div id="cancel-confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-30 hidden p-4">
        <div class="modern-card p-8 text-center max-w-md w-full mx-auto transform transition-all duration-300 scale-95">
            <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-gradient-to-r from-red-500 to-pink-600 mb-6">
                <svg class="h-8 w-8 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
                </svg>
            </div>
            <h3 class="text-xl md:text-2xl font-bold mb-3 text-gray-800">⚠️ Cancelar Cita</h3>
            <p class="text-gray-600 mb-6 text-sm md:text-base leading-relaxed">
                Esta acción cancelará permanentemente la cita seleccionada y se registrará en el historial. 
            </p>
            
            <!-- Campo para el motivo de cancelación -->
            <div class="mb-6 text-left">
                <label for="cancel-reason" class="block text-sm font-semibold text-gray-700 mb-2">
                    📝 Motivo de la cancelación
                </label>
                <textarea id="cancel-reason" 
                          class="neu-button w-full p-3 border-0 rounded-lg focus:ring-4 focus:ring-red-200 transition resize-none" 
                          placeholder="Describe el motivo de la cancelación..."
                          rows="3"
                          style="font-size: 14px;"></textarea>
            </div>
            
            <div class="flex flex-col sm:flex-row justify-center gap-4">
                <button id="confirm-cancel-btn" class="px-8 py-3 rounded-lg font-semibold transition-all duration-200 bg-gradient-to-r from-red-500 to-red-600 text-white hover:from-red-600 hover:to-red-700 transform hover:scale-105">
                    Confirmar Cancelación
                </button>
                <button id="keep-appointment-btn" class="neu-button text-gray-700 px-8 py-3 font-semibold">
                    Mantener Cita
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmación para Limpiar Historial -->
    <div id="clear-history-confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50 hidden p-4">
        <div class="modern-card p-8 text-center max-w-md w-full mx-auto transform transition-all duration-300 scale-95">
            <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-gradient-to-r from-red-500 to-red-600 mb-6">
                <svg class="h-8 w-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"/>
                </svg>
            </div>
            
            <h3 class="text-xl font-bold text-gray-900 mb-2">
                ⚠️ Limpiar Historial Completo
            </h3>
            
            <p class="text-gray-600 mb-6">
                Esta acción eliminará <strong>TODAS</strong> las cancelaciones del historial de forma permanente. 
                <br><br>
                <span class="text-red-600 font-semibold">⚠️ Esta acción no se puede deshacer</span>
            </p>
            
            <div class="flex flex-col sm:flex-row justify-center gap-4">
                <button id="confirm-clear-history-btn" class="px-6 py-3 rounded-lg font-semibold transition-all duration-200 bg-gradient-to-r from-red-500 to-red-600 text-white hover:from-red-600 hover:to-red-700 transform hover:scale-105">
                    <svg class="w-5 h-5 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                    </svg>
                    Sí, Limpiar Todo
                </button>
                <button id="cancel-clear-history-btn" class="neu-button text-gray-700 px-6 py-3 font-semibold">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal para Agregar Cita Manualmente con diseño avanzado -->
    <div id="manual-appointment-modal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-40 hidden p-4">
        <div class="modern-card p-8 w-full max-w-2xl mx-auto max-h-[90vh] overflow-y-auto transform transition-all duration-300">
            <div class="flex justify-between items-center mb-8">
                <div>
                    <h2 class="text-2xl md:text-3xl font-bold text-gradient mb-2">✨ Nueva Cita</h2>
                    <p class="text-gray-600">Agenda una cita de forma manual</p>
                </div>
                <button id="close-manual-appointment-modal-btn" class="neu-button p-3 text-gray-500 hover:text-gray-800">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            
            <form id="manual-appointment-form" class="space-y-6">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="lg:col-span-2">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">👤 Nombre Completo</label>
                        <input type="text" id="manual-nombre" 
                               class="neu-button w-full p-4 border-0 rounded-lg focus:ring-4 focus:ring-blue-200 transition" 
                               placeholder="Ingresa el nombre del cliente" required style="font-size: 16px;">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">📱 Teléfono Principal</label>
                        <input type="tel" id="manual-telefono" 
                               class="neu-button w-full p-4 border-0 rounded-lg focus:ring-4 focus:ring-blue-200 transition" 
                               placeholder="Número principal" required style="font-size: 16px;">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">📞 Teléfono Alternativo</label>
                        <input type="tel" id="manual-telefono2" 
                               class="neu-button w-full p-4 border-0 rounded-lg focus:ring-4 focus:ring-blue-200 transition" 
                               placeholder="Número alternativo (opcional)" style="font-size: 16px;">
                    </div>
                    
                    <div class="lg:col-span-2">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">💄 Servicio</label>
                        <input type="text" id="manual-servicio" 
                               class="neu-button w-full p-4 border-0 rounded-lg focus:ring-4 focus:ring-blue-200 transition" 
                               placeholder="Describe el servicio solicitado" required style="font-size: 16px;">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">📅 Fecha</label>
                        <input type="date" id="manual-fecha" 
                               class="neu-button w-full p-4 border-0 rounded-lg focus:ring-4 focus:ring-blue-200 transition" 
                               required style="font-size: 16px;">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">⏰ Hora</label>
                        <input type="time" id="manual-hora" 
                               class="neu-button w-full p-4 border-0 rounded-lg focus:ring-4 focus:ring-blue-200 transition" 
                               required style="font-size: 16px;">
                    </div>
                </div>
                
                <div class="pt-6 border-t border-gray-200">
                    <button type="submit" class="btn-gradient w-full py-4 text-lg font-semibold">
                        <svg class="w-5 h-5 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                        Crear Cita
                    </button>
                </div>
            </form>
            
            <div id="manual-appointment-success" class="hidden mt-6 p-4 bg-green-50 border border-green-200 rounded-lg">
                <div class="flex items-center">
                    <svg class="w-5 h-5 text-green-400 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                    </svg>
                    <span class="text-green-800 font-medium">¡Cita creada exitosamente! ✨</span>
                </div>
            </div>
            
            <div id="manual-appointment-error" class="hidden mt-6 p-4 bg-red-50 border border-red-200 rounded-lg">
                <div class="flex items-center">
                    <svg class="w-5 h-5 text-red-400 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                    </svg>
                    <span class="text-red-800 font-medium">Error al crear la cita. Intenta nuevamente.</span>
                </div>
            </div>
        </div>
    </div>
    <script>
        // Función para hacer scroll hacia arriba suavemente
        function scrollToTop() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }

        // Elementos principales
        const appointmentsTableBody = document.getElementById('appointments-table-body');
        const todayAppointmentsBody = document.getElementById('today-appointments-body');
        const cancelLogTableBody = document.getElementById('cancel-log-table-body');
        const manualAppointmentModal = document.getElementById('manual-appointment-modal');
        const manualAppointmentForm = document.getElementById('manual-appointment-form');
        const blockDateInput = document.getElementById('block-date');
        const saveBlockedHoursBtn = document.getElementById('save-blocked-hours');
        const todayDateElement = document.getElementById('today-date');
        
        // Elementos del modal de limpiar historial
        const clearHistoryBtn = document.getElementById('clear-history-btn');
        const clearHistoryConfirmModal = document.getElementById('clear-history-confirm-modal');
        const confirmClearHistoryBtn = document.getElementById('confirm-clear-history-btn');
        const cancelClearHistoryBtn = document.getElementById('cancel-clear-history-btn');

        // Cargar datos cuando el DOM esté listo
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Documento cargado, iniciando carga de datos...');
            loadTodayAppointments();
            loadAppointments();
            loadCancellations();
            generateTimeSlots();
            updateDashboardStats(); // Actualizar estadísticas iniciales
            
            // Verificar si hay parámetros de URL para edición
            checkForEditParams();
        });

        // Función para verificar parámetros de URL para edición de citas
        function checkForEditParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const editId = urlParams.get('edit');
            
            if (editId) {
                console.log('Detectados parámetros de edición para cita:', editId);
                
                // Pre-llenar el formulario con los datos de la URL
                const name = urlParams.get('name');
                const phone = urlParams.get('phone');
                const service = urlParams.get('service');
                const date = urlParams.get('date');
                const time = urlParams.get('time');
                
                if (name && phone && service && date && time) {
                    // Abrir el modal de cita manual
                    if (manualAppointmentModal) {
                        manualAppointmentModal.classList.remove('hidden');
                        
                        // Pre-llenar los campos
                        setTimeout(() => {
                            const nameField = document.getElementById('manual-nombre');
                            const phoneField = document.getElementById('manual-telefono');
                            const serviceField = document.getElementById('manual-servicio');
                            const dateField = document.getElementById('manual-fecha');
                            const timeField = document.getElementById('manual-hora');
                            
                            if (nameField) nameField.value = decodeURIComponent(name);
                            if (phoneField) phoneField.value = decodeURIComponent(phone);
                            if (serviceField) serviceField.value = decodeURIComponent(service);
                            if (dateField) dateField.value = date;
                            if (timeField) timeField.value = time;
                            
                            // Agregar atributo para identificar que es una edición
                            if (manualAppointmentForm) {
                                manualAppointmentForm.dataset.editId = editId;
                                
                                // Cambiar el título del modal
                                const modalTitle = manualAppointmentModal.querySelector('h2');
                                if (modalTitle) {
                                    modalTitle.innerHTML = '✏️ Editar Cita';
                                }
                                
                                // Cambiar el texto del botón
                                const submitBtn = manualAppointmentForm.querySelector('button[type="submit"]');
                                if (submitBtn) {
                                    submitBtn.innerHTML = `
                                        <svg class="w-5 h-5 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                        </svg>
                                        Actualizar Cita
                                    `;
                                }
                            }
                            
                            console.log('Formulario pre-llenado para edición');
                        }, 100);
                    }
                }
                
                // Limpiar la URL para evitar problemas
                if (window.history && window.history.replaceState) {
                    window.history.replaceState(null, null, window.location.pathname);
                }
            }
        }

        // Variable global para almacenar todas las citas
        let allAppointments = [];

        // Función para actualizar las estadísticas del dashboard
        function updateDashboardStats() {
            console.log('Actualizando estadísticas del dashboard...');
            
            if (!allAppointments || allAppointments.length === 0) {
                console.log('No hay citas disponibles para calcular estadísticas');
                // Establecer valores en 0 si no hay citas
                document.getElementById('citas-hoy-count').textContent = '0';
                document.getElementById('confirmadas-count').textContent = '0';
                document.getElementById('pendientes-count').textContent = '0';
                document.getElementById('satisfaccion-count').textContent = '100%';
                return;
            }

            const today = new Date().toISOString().split('T')[0];
            
            // Debug: mostrar todas las citas para analizar los estados
            console.log('Todas las citas:', allAppointments.map(cita => ({
                id: cita.id,
                fecha: cita.fecha,
                estado: cita.estado,
                confirmada: cita.confirmada
            })));
            
            // Calcular estadísticas
            const citasHoy = allAppointments.filter(cita => cita.fecha === today).length;
            
            // Buscar citas confirmadas por diferentes criterios
            const confirmadas = allAppointments.filter(cita => 
                cita.confirmada === true || 
                cita.confirmada === 'true' ||
                cita.estado === 'Confirmada' || 
                cita.estado === 'confirmada' || 
                cita.estado === 'Confirmado' ||
                cita.estado === 'confirmado'
            ).length;
            
            // Buscar citas pendientes
            const pendientes = allAppointments.filter(cita => 
                (cita.confirmada === false || cita.confirmada === 'false' || cita.confirmada === undefined) &&
                (cita.estado === 'Pendiente' || 
                 cita.estado === 'pendiente' || 
                 cita.estado === 'Pendientes' ||
                 cita.estado === undefined ||
                 cita.estado === null ||
                 cita.estado === '')
            ).length;
            
            // Calcular satisfacción (puede ser un cálculo más complejo)
            const totalCitas = allAppointments.length;
            const citasCompletadas = confirmadas;
            const satisfaccion = totalCitas > 0 ? Math.round((citasCompletadas / totalCitas) * 100) : 100;

            console.log('Estadísticas calculadas:', {
                citasHoy,
                confirmadas,
                pendientes,
                satisfaccion: satisfaccion + '%',
                totalCitas
            });

            // Actualizar los elementos del DOM
            const citasHoyElement = document.getElementById('citas-hoy-count');
            const confirmadasElement = document.getElementById('confirmadas-count');
            const pendientesElement = document.getElementById('pendientes-count');
            const satisfaccionElement = document.getElementById('satisfaccion-count');

            if (citasHoyElement) {
                citasHoyElement.textContent = citasHoy;
                console.log('Actualizado citas hoy:', citasHoy);
            }
            
            if (confirmadasElement) {
                confirmadasElement.textContent = confirmadas;
                console.log('Actualizado confirmadas:', confirmadas);
            }
            
            if (pendientesElement) {
                pendientesElement.textContent = pendientes;
                console.log('Actualizado pendientes:', pendientes);
            }
            
            if (satisfaccionElement) {
                satisfaccionElement.textContent = satisfaccion + '%';
                console.log('Actualizado satisfacción:', satisfaccion + '%');
            }
        }

        // Función para cargar las citas de hoy
        function loadTodayAppointments() {
            console.log('Cargando citas de hoy...');
            
            const today = new Date();
            const formattedDate = today.toISOString().split('T')[0];
            console.log('Fecha actual:', formattedDate);

            // Mostrar la fecha actual en formato legible
            if (todayDateElement) {
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                todayDateElement.textContent = today.toLocaleDateString('es-ES', options);
            }

            // Si allAppointments existe, filtrar desde ahí
            if (allAppointments && allAppointments.length > 0) {
                const todayAppointments = allAppointments.filter(appointment => appointment.fecha === formattedDate);
                console.log('Citas de hoy encontradas:', todayAppointments.length);
                renderTodayAppointments(todayAppointments);
            } else {
                // Si no hay allAppointments, hacer consulta directa
                if (!window.db || !window.firebase) {
                    console.error('Firebase no está disponible');
                    return;
                }

                const citasRef = window.firebase.collection(window.db, 'citas');
                
                window.firebase.onSnapshot(citasRef, (querySnapshot) => {
                    console.log('Citas encontradas:', querySnapshot.size);
                    const todayAppointments = [];
                    querySnapshot.forEach((doc) => {
                        const appointmentData = {
                            id: doc.id,
                            ...doc.data()
                        };
                        
                        // Filtrar solo citas de hoy
                        if (appointmentData.fecha === formattedDate) {
                            todayAppointments.push(appointmentData);
                        }
                    });
                    
                    console.log('Citas de hoy filtradas:', todayAppointments.length);
                    renderTodayAppointments(todayAppointments);
                }, (error) => {
                    console.error('Error al cargar citas:', error);
                    if (todayAppointmentsBody) {
                        todayAppointmentsBody.innerHTML = `
                            <tr><td colspan="5" class="p-4 text-center text-red-500">Error al cargar las citas: ${error.message}</td></tr>
                        `;
                    }
                });
            }
        }

        // Función para renderizar las citas de hoy con diseño moderno
        function renderTodayAppointments(appointments) {
            console.log('Renderizando citas de hoy:', appointments);
            if (!todayAppointmentsBody) {
                console.error('No se encontró el elemento todayAppointmentsBody');
                return;
            }

            if (appointments.length === 0) {
                todayAppointmentsBody.innerHTML = `
                    <tr><td colspan="5" class="py-12 text-center">
                        <div class="flex flex-col items-center">
                            <div class="w-16 h-16 rounded-full bg-gray-100 flex items-center justify-center mb-4">
                                <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3a4 4 0 118 0v4m-4 8a2 2 0 11-4 0m4 0a2 2 0 104 0m-4 0V9a2 2 0 014 0v4"/>
                                </svg>
                            </div>
                            <p class="text-gray-500 font-medium">No hay citas programadas para hoy</p>
                            <p class="text-gray-400 text-sm mt-1">¡Perfecto momento para relajarse! 😊</p>
                        </div>
                    </td></tr>
                `;
                return;
            }

            // Ordenar las citas por hora
            appointments.sort((a, b) => a.hora.localeCompare(b.hora));

            const html = appointments.map(appointment => `
                <tr class="hover:bg-gradient-to-r hover:from-blue-50 hover:to-purple-50 transition-all duration-200">
                    <td class="py-4 font-semibold text-gray-800">${appointment.hora || ''}</td>
                    <td class="py-4">
                        <div class="font-medium text-gray-900">${appointment.nombre || ''}</div>
                    </td>
                    <td class="py-4">
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-purple-100 text-purple-800">
                            ${appointment.servicio || ''}
                        </span>
                    </td>
                    <td class="py-4 hide-mobile text-gray-600">${appointment.telefono || ''}</td>
                    <td class="py-4">
                        <span class="status-badge ${appointment.confirmada ? 'status-confirmed' : 'status-pending'}">
                            ${appointment.confirmada ? '✓ Confirmada' : '⏳ Pendiente'}
                        </span>
                    </td>
                </tr>
            `).join('');

            todayAppointmentsBody.innerHTML = html;
        }
        
        // Variables globales para la selección múltiple
        let pendingChanges = new Map(); // Mapa de cambios pendientes: time -> 'block'/'unblock'
        let originalStates = new Map(); // Estados originales para poder revertir

        // Función para manejar la selección múltiple de slots
        function handleSlotClick(slot) {
            const time = slot.dataset.time;
            const isCurrentlyAvailable = slot.classList.contains('available');
            const isCurrentlyUnavailable = slot.classList.contains('unavailable');
            
            // Determinar el nuevo estado que queremos
            let newAction;
            if (pendingChanges.has(time)) {
                // Si ya hay un cambio pendiente, cancelarlo
                pendingChanges.delete(time);
                // Restaurar al estado original
                resetSlotToOriginal(slot, time);
            } else {
                // Crear nuevo cambio pendiente
                if (isCurrentlyAvailable) {
                    newAction = 'block';
                    slot.classList.remove('available');
                    slot.classList.add('pending-block');
                } else if (isCurrentlyUnavailable) {
                    newAction = 'unblock';
                    slot.classList.remove('unavailable');
                    slot.classList.add('pending-unblock');
                }
                
                if (newAction) {
                    // Guardar estado original si no existe
                    if (!originalStates.has(time)) {
                        originalStates.set(time, isCurrentlyAvailable ? 'available' : 'unavailable');
                    }
                    pendingChanges.set(time, newAction);
                }
            }
            
            updateSaveButtonState();
        }

        // Función para resetear un slot a su estado original
        function resetSlotToOriginal(slot, time) {
            const originalState = originalStates.get(time);
            slot.classList.remove('pending-block', 'pending-unblock', 'available', 'unavailable');
            
            if (originalState === 'available') {
                slot.classList.add('available');
            } else {
                slot.classList.add('unavailable');
            }
        }

        // Función para actualizar el estado del botón guardar
        function updateSaveButtonState() {
            const saveBtn = document.getElementById('save-blocked-hours');
            const changesCount = pendingChanges.size;
            
            if (changesCount > 0) {
                saveBtn.innerHTML = `
                    <svg class="w-5 h-5 mr-2 inline animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                    </svg>
                    Guardar ${changesCount} Cambio${changesCount > 1 ? 's' : ''}
                `;
                saveBtn.classList.add('confirm-btn-pending');
                saveBtn.disabled = false;
            } else {
                saveBtn.innerHTML = `
                    <svg class="w-5 h-5 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                    </svg>
                    Guardar Configuración
                `;
                saveBtn.classList.remove('confirm-btn-pending');
                saveBtn.disabled = true;
            }
        }

        // Generar slots de tiempo
        function generateTimeSlots() {
            const container = document.querySelector('#time-slots-grid');
            if (!container) {
                console.error('No se encontró el contenedor de slots de tiempo');
                return;
            }
            container.innerHTML = '';
            
            // Generar slots de 8:00 AM a 10:00 PM cada 30 minutos
            for (let hour = 8; hour < 22; hour++) {
                for (let minutes = 0; minutes < 60; minutes += 30) {
                    const time = `${hour.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
                    const slot = document.createElement('div');
                    slot.className = 'time-slot available';
                    slot.dataset.time = time;
                    slot.textContent = time;
                    container.appendChild(slot);
                    
                    // Evento de click usando la nueva función de manejo
                    slot.addEventListener('click', () => handleSlotClick(slot));
                }
            }
            
            // Cargar horarios bloqueados para la fecha seleccionada
            loadBlockedHours();
        }
        
        // Cargar horarios bloqueados
        async function loadBlockedHours() {
            if (!blockDateInput.value || !window.db || !window.firebase) return;
            
            try {
                // Limpiar cambios pendientes al cargar nueva fecha
                pendingChanges.clear();
                originalStates.clear();
                updateSaveButtonState();
                
                const docRef = window.firebase.doc(window.db, 'horarios_bloqueados', blockDateInput.value);
                const docSnap = await window.firebase.getDoc(docRef);
                
                if (docSnap.exists()) {
                    const blockedHours = docSnap.data().horas || [];
                    const slots = document.querySelectorAll('.time-slot');
                    
                    slots.forEach(slot => {
                        // Limpiar todos los estados anteriores
                        slot.classList.remove('available', 'unavailable', 'pending-block', 'pending-unblock');
                        
                        if (blockedHours.includes(slot.dataset.time)) {
                            slot.classList.add('unavailable');
                        } else {
                            slot.classList.add('available');
                        }
                    });
                } else {
                    // Si no hay datos, todos los slots están disponibles
                    const slots = document.querySelectorAll('.time-slot');
                    slots.forEach(slot => {
                        slot.classList.remove('available', 'unavailable', 'pending-block', 'pending-unblock');
                        slot.classList.add('available');
                    });
                }
            } catch (error) {
                console.error('Error al cargar horarios bloqueados:', error);
            }
        }
        
        // Guardar horarios bloqueados (aplicar cambios pendientes)
        async function saveBlockedHours() {
            if (!blockDateInput.value || !window.db || !window.firebase) return;
            if (pendingChanges.size === 0) {
                alert('No hay cambios pendientes para guardar.');
                return;
            }
            
            try {
                // Aplicar cambios pendientes
                pendingChanges.forEach((action, time) => {
                    const slot = document.querySelector(`[data-time="${time}"]`);
                    if (slot) {
                        slot.classList.remove('pending-block', 'pending-unblock', 'available', 'unavailable');
                        if (action === 'block') {
                            slot.classList.add('unavailable');
                        } else {
                            slot.classList.add('available');
                        }
                    }
                });
                
                // Obtener todos los horarios bloqueados actualizados
                const blockedHours = Array.from(document.querySelectorAll('.time-slot.unavailable'))
                    .map(slot => slot.dataset.time);
                
                // Guardar en Firebase
                await window.firebase.setDoc(
                    window.firebase.doc(window.db, 'horarios_bloqueados', blockDateInput.value),
                    { horas: blockedHours }
                );
                
                // Limpiar cambios pendientes
                pendingChanges.clear();
                originalStates.clear();
                updateSaveButtonState();
                
                // Mostrar mensaje de éxito
                const saveBtn = document.getElementById('save-blocked-hours');
                const originalHTML = saveBtn.innerHTML;
                saveBtn.innerHTML = `
                    <svg class="w-5 h-5 mr-2 inline text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                    </svg>
                    ¡Guardado exitosamente!
                `;
                saveBtn.classList.add('bg-green-500');
                
                setTimeout(() => {
                    saveBtn.innerHTML = originalHTML;
                    saveBtn.classList.remove('bg-green-500');
                }, 2000);
                
            } catch (error) {
                console.error('Error al guardar horarios bloqueados:', error);
                alert('Error al guardar horarios bloqueados');
            }
        }

        // Elementos de los modales
        const openModalBtn = document.getElementById('open-manual-appointment-modal-btn');
        const closeModalBtn = document.getElementById('close-manual-appointment-modal-btn');
        const manualSuccess = document.getElementById('manual-appointment-success');
        const manualError = document.getElementById('manual-appointment-error');
        const confirmCancelBtn = document.getElementById('confirm-cancel-btn');
        const keepAppointmentBtn = document.getElementById('keep-appointment-btn');
        const cancelConfirmModal = document.getElementById('cancel-confirm-modal');

        // Función para cargar las citas
        function loadAppointments() {
            if (!window.db || !window.firebase) {
                console.error('Firebase no está disponible');
                return;
            }

            console.log('Cargando todas las citas...');

            // Consulta simple sin filtros para evitar problemas de índice
            const citasRef = window.firebase.collection(window.db, 'citas');

            window.firebase.onSnapshot(citasRef, (querySnapshot) => {
                console.log('Citas encontradas:', querySnapshot.size);
                allAppointments = [];
                const today = new Date().toISOString().split('T')[0];
                
                querySnapshot.forEach((doc) => {
                    const appointmentData = {
                        id: doc.id,
                        ...doc.data()
                    };
                    
                    // Filtrar solo citas actuales y futuras en el cliente
                    if (appointmentData.fecha >= today) {
                        allAppointments.push(appointmentData);
                    }
                });

                // Ordenar todas las citas por fecha y hora
                allAppointments.sort((a, b) => {
                    if (a.fecha === b.fecha) {
                        return a.hora.localeCompare(b.hora);
                    }
                    return a.fecha.localeCompare(b.fecha);
                });

                console.log('Citas filtradas y ordenadas:', allAppointments.length);
                
                // Actualizar ambas vistas
                renderAppointments(allAppointments);
                loadTodayAppointments(); // Actualizar la vista de citas de hoy
                updateDashboardStats(); // Actualizar estadísticas del dashboard
            }, (error) => {
                console.error('Error al cargar citas:', error);
                if (appointmentsTableBody) {
                    appointmentsTableBody.innerHTML = `
                        <tr><td colspan="5" class="p-4 text-center text-red-500">Error al cargar las citas: ${error.message}</td></tr>
                    `;
                }
            });
        }

        // Función para renderizar las citas en la tabla con diseño moderno
        function renderAppointments(appointments) {
            if (!appointmentsTableBody) return;

            if (appointments.length === 0) {
                appointmentsTableBody.innerHTML = `
                    <tr><td colspan="5" class="py-12 text-center">
                        <div class="flex flex-col items-center">
                            <div class="w-20 h-20 rounded-full bg-gradient-to-r from-blue-100 to-purple-100 flex items-center justify-center mb-6">
                                <svg class="w-10 h-10 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3a4 4 0 118 0v4m-4 8a2 2 0 11-4 0m4 0a2 2 0 104 0m-4 0V9a2 2 0 014 0v4"/>
                                </svg>
                            </div>
                            <h3 class="text-lg font-semibold text-gray-700 mb-2">No hay citas registradas</h3>
                            <p class="text-gray-500">Comienza agregando la primera cita</p>
                            <button class="btn-gradient mt-4 text-sm">+ Agregar Primera Cita</button>
                        </div>
                    </td></tr>
                `;
                return;
            }

            const html = appointments.map(appointment => `
                <tr class="hover:bg-gradient-to-r hover:from-blue-50 hover:to-purple-50 transition-all duration-200 ${!appointment.confirmada ? 'border-l-4 border-l-yellow-400' : ''}">
                    <td class="py-4">
                        <div class="font-semibold text-gray-900">${appointment.fecha || ''}</div>
                    </td>
                    <td class="py-4">
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800">
                            ${appointment.hora || ''}
                        </span>
                    </td>
                    <td class="py-4">
                        <div class="font-medium text-gray-900">${appointment.nombre || ''}</div>
                        <div class="text-sm text-gray-500">${appointment.servicio || ''}</div>
                    </td>
                    <td class="py-4 hide-mobile">
                        <a href="tel:${appointment.telefono}" class="text-blue-600 hover:text-blue-800 transition">
                            ${appointment.telefono || ''}
                        </a>
                    </td>
                    <td class="py-4">
                        <div class="flex items-center space-x-2">
                            ${!appointment.confirmada ? `
                                <button onclick="confirmarCita('${appointment.id}', '${appointment.telefono}', '${appointment.nombre}', '${appointment.fecha}', '${appointment.hora}', '${appointment.servicio}')" 
                                        class="neu-button px-3 py-2 text-green-600 hover:text-green-800 transition micro-bounce text-sm">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1 inline" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                    </svg>
                                    Confirmar
                                </button>
                            ` : `
                                <span class="status-badge status-confirmed text-xs">Confirmada</span>
                            `}
                            <button onclick="cancelAppointment('${appointment.id}')" 
                                    class="neu-button px-3 py-2 text-red-600 hover:text-red-800 transition micro-bounce text-sm">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1 inline" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" clip-rule="evenodd"/>
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 000 2h4a1 1 0 100-2H8z" clip-rule="evenodd"/>
                                </svg>
                                Cancelar
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');

            appointmentsTableBody.innerHTML = html;
        }

        // Variable global para almacenar el ID de la cita a cancelar
        let appointmentToCancel = null;

        // Función para abrir el modal de cancelación
        window.cancelAppointment = async function(id) {
            appointmentToCancel = id;
            const modal = document.getElementById('cancel-confirm-modal');
            const reasonField = document.getElementById('cancel-reason');
            
            if (modal && reasonField) {
                // Limpiar el campo de motivo
                reasonField.value = '';
                // Mostrar el modal
                modal.classList.remove('hidden');
            }
        }

        // Función para procesar la cancelación definitiva
        async function processCancellation(appointmentId, reason) {
            if (!window.db || !window.firebase || !appointmentId) return false;
            
            try {
                // Obtener los datos de la cita antes de eliminarla
                const appointmentRef = window.firebase.doc(window.db, 'citas', appointmentId);
                const appointmentDoc = await window.firebase.getDoc(appointmentRef);
                
                if (!appointmentDoc.exists()) {
                    throw new Error('La cita no existe');
                }
                
                const appointmentData = appointmentDoc.data();
                
                // Crear el registro de cancelación
                const cancellationData = {
                    ...appointmentData, // Incluir todos los datos originales de la cita
                    motivo: reason || 'No especificado',
                    fechaCancelacion: new Date().toISOString(),
                    fechaCancelacionLocal: new Date().toLocaleDateString('es-ES'),
                    horaCancelacion: new Date().toLocaleTimeString('es-ES', { 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    })
                };
                
                // Guardar en la colección de cancelaciones
                await window.firebase.addDoc(
                    window.firebase.collection(window.db, 'cancelaciones'),
                    cancellationData
                );
                
                // Eliminar la cita original
                await window.firebase.deleteDoc(appointmentRef);
                
                console.log('Cita cancelada y registrada en historial exitosamente');
                return true;
                
            } catch (error) {
                console.error('Error al procesar la cancelación:', error);
                throw error;
            }
        }

        // Función para cargar cancelaciones
        function loadCancellations() {
            if (!window.db || !window.firebase) return;

            const q = window.firebase.query(
                window.firebase.collection(window.db, 'cancelaciones'),
                window.firebase.orderBy('fechaCancelacion', 'desc')
            );

            window.firebase.onSnapshot(q, (querySnapshot) => {
                const cancellations = [];
                querySnapshot.forEach((doc) => {
                    cancellations.push(doc.data());
                });

                renderCancellations(cancellations);
            });
        }

        // Función para limpiar todo el historial de cancelaciones
        async function clearAllCancellations() {
            if (!window.db || !window.firebase) {
                throw new Error('Firebase no está disponible');
            }

            console.log('Iniciando limpieza del historial de cancelaciones...');

            try {
                // Obtener todas las cancelaciones
                const q = window.firebase.query(
                    window.firebase.collection(window.db, 'cancelaciones')
                );
                
                const querySnapshot = await window.firebase.getDocs(q);
                
                if (querySnapshot.empty) {
                    console.log('No hay cancelaciones para eliminar');
                    return;
                }

                console.log(`Eliminando ${querySnapshot.size} cancelaciones...`);

                // Crear batch para eliminar todos los documentos
                const batch = [];
                
                querySnapshot.forEach((doc) => {
                    batch.push(window.firebase.deleteDoc(doc.ref));
                });

                // Ejecutar todas las eliminaciones
                await Promise.all(batch);

                console.log('Historial de cancelaciones limpiado exitosamente');
                
            } catch (error) {
                console.error('Error al limpiar historial de cancelaciones:', error);
                throw error;
            }
        }

        // Función para renderizar cancelaciones
        function renderCancellations(cancellations) {
            if (!cancelLogTableBody) return;

            if (cancellations.length === 0) {
                cancelLogTableBody.innerHTML = `
                    <tr><td colspan="5" class="py-12 text-center">
                        <div class="flex flex-col items-center">
                            <div class="w-16 h-16 rounded-full bg-gradient-to-r from-red-100 to-pink-100 flex items-center justify-center mb-4">
                                <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4"/>
                                </svg>
                            </div>
                            <h3 class="text-lg font-semibold text-gray-700 mb-2">Sin cancelaciones</h3>
                            <p class="text-gray-500">No hay citas canceladas registradas</p>
                        </div>
                    </td></tr>
                `;
                return;
            }

            const html = cancellations.map(cancellation => `
                <tr class="hover:bg-red-50 transition-all duration-200">
                    <td class="py-4">
                        <div class="font-medium text-gray-900">${cancellation.fecha || ''}</div>
                        <div class="text-xs text-gray-500">Cancelada: ${cancellation.fechaCancelacionLocal || 'N/A'}</div>
                    </td>
                    <td class="py-4">
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-sm font-medium bg-red-100 text-red-800">
                            ${cancellation.hora || ''}
                        </span>
                    </td>
                    <td class="py-4">
                        <div class="font-medium text-gray-900">${cancellation.nombre || ''}</div>
                        <div class="text-sm text-gray-500">${cancellation.servicio || ''}</div>
                    </td>
                    <td class="py-4 hide-mobile">
                        <div class="font-medium text-gray-700">${cancellation.telefono || ''}</div>
                        ${cancellation.telefono2 ? `<div class="text-sm text-gray-500">${cancellation.telefono2}</div>` : ''}
                    </td>
                    <td class="py-4">
                        <div class="bg-gray-100 rounded-lg p-3 max-w-xs">
                            <p class="text-sm text-gray-800 font-medium">${cancellation.motivo || 'No especificado'}</p>
                            ${cancellation.horaCancelacion ? `<p class="text-xs text-gray-500 mt-1">A las ${cancellation.horaCancelacion}</p>` : ''}
                        </div>
                    </td>
                </tr>
            `).join('');

            cancelLogTableBody.innerHTML = html;
        }

        // Configurar el modal de agregar cita
        if (openModalBtn && manualAppointmentModal) {
            openModalBtn.addEventListener('click', () => {
                manualAppointmentModal.classList.remove('hidden');
            });
        }

        if (closeModalBtn && manualAppointmentModal) {
            closeModalBtn.addEventListener('click', () => {
                manualAppointmentModal.classList.add('hidden');
            });
        }

        // Manejar el formulario de agregar/editar cita
        if (manualAppointmentForm) {
            manualAppointmentForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                const isEditing = manualAppointmentForm.dataset.editId;
                const formData = {
                    nombre: document.getElementById('manual-nombre').value,
                    telefono: document.getElementById('manual-telefono').value,
                    telefono2: document.getElementById('manual-telefono2').value || '',
                    servicio: document.getElementById('manual-servicio').value,
                    fecha: document.getElementById('manual-fecha').value,
                    hora: document.getElementById('manual-hora').value,
                    estado: 'pendiente',
                    confirmada: false,
                    fechaCreacion: isEditing ? undefined : new Date().toISOString()
                };

                try {
                    if (isEditing) {
                        // Actualizar cita existente
                        console.log('Actualizando cita:', isEditing);
                        await window.firebase.updateDoc(
                            window.firebase.doc(window.db, 'citas', isEditing),
                            formData
                        );
                        
                        // Mostrar mensaje de éxito para edición
                        if (manualSuccess) {
                            manualSuccess.querySelector('span').textContent = '¡Cita actualizada exitosamente! ✨';
                            manualSuccess.classList.remove('hidden');
                        }
                        
                        console.log('Cita actualizada exitosamente');
                    } else {
                        // Crear nueva cita
                        console.log('Creando nueva cita');
                        await window.firebase.addDoc(
                            window.firebase.collection(window.db, 'citas'),
                            formData
                        );
                        
                        // Enviar correo de notificación solo para citas nuevas
                        await sendAppointmentEmail(formData);
                        
                        // Mostrar mensaje de éxito para creación
                        if (manualSuccess) {
                            manualSuccess.querySelector('span').textContent = '¡Cita creada exitosamente! ✨';
                            manualSuccess.classList.remove('hidden');
                        }
                        
                        console.log('Cita creada exitosamente');
                    }

                    // Recargar las citas
                    loadAppointments();
                    loadTodayAppointments();
                    updateDashboardStats(); // Actualizar estadísticas después de crear/editar

                    // Limpiar formulario después de 2 segundos
                    setTimeout(() => {
                        manualAppointmentForm.reset();
                        if (manualSuccess) manualSuccess.classList.add('hidden');
                        if (manualError) manualError.classList.add('hidden');
                        
                        // Limpiar el modo de edición
                        delete manualAppointmentForm.dataset.editId;
                        
                        // Restaurar título y botón originales
                        const modalTitle = manualAppointmentModal.querySelector('h2');
                        if (modalTitle) {
                            modalTitle.innerHTML = '✨ Nueva Cita';
                        }
                        
                        const submitBtn = manualAppointmentForm.querySelector('button[type="submit"]');
                        if (submitBtn) {
                            submitBtn.innerHTML = `
                                <svg class="w-5 h-5 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                                </svg>
                                Crear Cita
                            `;
                        }
                        
                        // Cerrar modal
                        manualAppointmentModal.classList.add('hidden');
                    }, 2000);

                } catch (error) {
                    console.error('Error al procesar la cita:', error);
                    if (manualError) {
                        manualError.querySelector('span').textContent = `Error al ${isEditing ? 'actualizar' : 'crear'} la cita. Intenta nuevamente.`;
                        manualError.classList.remove('hidden');
                    }
                }
            });
        }

        // Event listeners para el gestor de horarios bloqueados
        if (blockDateInput) {
            blockDateInput.addEventListener('change', generateTimeSlots);
        }
        
        if (saveBlockedHoursBtn) {
            saveBlockedHoursBtn.addEventListener('click', saveBlockedHours);
        }

        // Event listener para el botón de limpiar cambios
        const clearAllChangesBtn = document.getElementById('clear-all-changes');
        if (clearAllChangesBtn) {
            clearAllChangesBtn.addEventListener('click', function() {
                // Confirmar antes de limpiar
                if (pendingChanges.size > 0) {
                    if (confirm(`¿Estás segura de que quieres cancelar ${pendingChanges.size} cambio${pendingChanges.size > 1 ? 's' : ''} pendiente${pendingChanges.size > 1 ? 's' : ''}?`)) {
                        clearPendingChanges();
                    }
                } else {
                    alert('No hay cambios pendientes para limpiar.');
                }
            });
        }

        // Función para limpiar cambios pendientes
        function clearPendingChanges() {
            // Restaurar todos los slots a su estado original
            pendingChanges.forEach((action, time) => {
                const slot = document.querySelector(`[data-time="${time}"]`);
                if (slot) {
                    resetSlotToOriginal(slot, time);
                }
            });
            
            // Limpiar mapas
            pendingChanges.clear();
            originalStates.clear();
            updateSaveButtonState();
        }

        // Función para confirmar cita y redirigir a WhatsApp
        window.confirmarCita = async function(id, telefono, nombre, fecha, hora, servicio) {
            if (!window.db || !window.firebase) return;
            
            try {
                // Actualizar el estado de la cita en Firebase
                await window.firebase.updateDoc(
                    window.firebase.doc(window.db, 'citas', id),
                    { confirmada: true }
                );

                // Actualizar estadísticas del dashboard
                updateDashboardStats();

                // Preparar mensaje de WhatsApp
                const mensaje = `¡Hola ${nombre}! 👋\n\nTe confirmo tu cita para ${servicio} el día ${fecha} a las ${hora}. 💄✨\n\n¡Gracias por elegir Yuridia Makeup! 🌟`;
                
                // Formatear número de teléfono (eliminar espacios y caracteres especiales)
                const telefonoLimpio = telefono.replace(/\D/g, '');
                
                // Crear URL de WhatsApp
                const whatsappURL = `https://wa.me/${telefonoLimpio}?text=${encodeURIComponent(mensaje)}`;
                
                // Abrir WhatsApp en una nueva ventana
                window.open(whatsappURL, '_blank');

            } catch (error) {
                console.error('Error al confirmar la cita:', error);
                alert('Error al confirmar la cita');
            }
        };

        // Función para renderizar las citas de hoy
        function renderTodayAppointments(appointments) {
            if (!todayAppointmentsBody) return;

            if (appointments.length === 0) {
                todayAppointmentsBody.innerHTML = `
                    <tr><td colspan="5" class="p-4 text-center text-gray-500">No hay citas programadas para hoy</td></tr>
                `;
                return;
            }

            const html = appointments.map(appointment => `
                <tr class="hover:bg-gray-50">
                    <td class="px-3 md:px-6 py-4 font-medium">${appointment.hora || ''}</td>
                    <td class="px-3 md:px-6 py-4">${appointment.nombre || ''}</td>
                    <td class="px-3 md:px-6 py-4">${appointment.servicio || ''}</td>
                    <td class="px-3 md:px-6 py-4">${appointment.telefono || ''}</td>
                    <td class="px-3 md:px-6 py-4">
                        <span class="px-2 py-1 text-xs font-semibold rounded-full ${
                            appointment.confirmada 
                            ? 'bg-green-100 text-green-800' 
                            : 'bg-yellow-100 text-yellow-800'
                        }">
                            ${appointment.confirmada ? 'Confirmada' : 'Pendiente'}
                        </span>
                    </td>
                </tr>
            `).join('');

            todayAppointmentsBody.innerHTML = html;
        }

        // Event listeners para el modal de cancelación
        if (confirmCancelBtn && cancelConfirmModal) {
            confirmCancelBtn.addEventListener('click', async () => {
                if (!appointmentToCancel) return;
                
                const reasonField = document.getElementById('cancel-reason');
                const reason = reasonField ? reasonField.value.trim() : '';
                
                try {
                    // Mostrar indicador de carga
                    confirmCancelBtn.disabled = true;
                    confirmCancelBtn.innerHTML = `
                        <svg class="w-5 h-5 mr-2 inline animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                        Procesando...
                    `;
                    
                    // Procesar la cancelación
                    await processCancellation(appointmentToCancel, reason);
                    
                    // Ocultar modal y mostrar mensaje de éxito
                    cancelConfirmModal.classList.add('hidden');
                    alert('✅ Cita cancelada exitosamente y registrada en el historial');
                    
                    // Recargar datos
                    loadAppointments();
                    loadTodayAppointments();
                    loadCancellations();
                    updateDashboardStats(); // Actualizar estadísticas después de cancelar
                    
                } catch (error) {
                    console.error('Error al cancelar la cita:', error);
                    alert('❌ Error al cancelar la cita: ' + error.message);
                } finally {
                    // Restaurar botón
                    confirmCancelBtn.disabled = false;
                    confirmCancelBtn.innerHTML = 'Confirmar Cancelación';
                    appointmentToCancel = null;
                }
            });
        }

        if (keepAppointmentBtn && cancelConfirmModal) {
            keepAppointmentBtn.addEventListener('click', () => {
                cancelConfirmModal.classList.add('hidden');
                appointmentToCancel = null;
                
                // Limpiar el campo de motivo
                const reasonField = document.getElementById('cancel-reason');
                if (reasonField) {
                    reasonField.value = '';
                }
            });
        }

        // Event listeners para limpiar historial
        if (clearHistoryBtn && clearHistoryConfirmModal) {
            clearHistoryBtn.addEventListener('click', () => {
                clearHistoryConfirmModal.classList.remove('hidden');
            });
        }

        if (confirmClearHistoryBtn && clearHistoryConfirmModal) {
            confirmClearHistoryBtn.addEventListener('click', async () => {
                try {
                    // Deshabilitar botón mientras se procesa
                    confirmClearHistoryBtn.disabled = true;
                    confirmClearHistoryBtn.innerHTML = `
                        <svg class="w-5 h-5 mr-2 inline animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                        Eliminando...
                    `;
                    
                    await clearAllCancellations();
                    
                    // Ocultar modal y mostrar mensaje de éxito
                    clearHistoryConfirmModal.classList.add('hidden');
                    alert('✅ Historial de cancelaciones limpiado exitosamente');
                    
                    // Recargar datos
                    loadCancellations();
                    
                } catch (error) {
                    console.error('Error al limpiar historial:', error);
                    alert('❌ Error al limpiar el historial: ' + error.message);
                } finally {
                    // Restaurar botón
                    confirmClearHistoryBtn.disabled = false;
                    confirmClearHistoryBtn.innerHTML = `
                        <svg class="w-5 h-5 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                        </svg>
                        Sí, Limpiar Todo
                    `;
                }
            });
        }

        if (cancelClearHistoryBtn && clearHistoryConfirmModal) {
            cancelClearHistoryBtn.addEventListener('click', () => {
                clearHistoryConfirmModal.classList.add('hidden');
            });
        }

        // Cargar datos cuando el DOM esté listo
        document.addEventListener('DOMContentLoaded', () => {
            loadAppointments();
            loadCancellations();
            loadTodayAppointments();
            if (blockDateInput) {
                blockDateInput.valueAsDate = new Date();
                generateTimeSlots();
            }
        });
    </script>
</body>
</html>